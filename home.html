<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <link rel="stylesheet" href="home.css">
  <title>home</title>
  
</head>
<body>
  
  
  <nav>
    <div class="nav-left">
      <div class="nav-img ">
      <img src="logo-circle.png ">
    </div>
    </div>
    <div class="nav-middle ">
      <div class="nav-icon-box">
        <div id="homeNav" class="nav-icon ">
        <img  id="homeGray" src="home.png">
        <img id="homeBlue" src="home-blue.png">
      </div>
      <div id="profileNav" class="nav-icon ">
        <img  id="profileGray" src="profile.png">
        <img  id="profileBlue" src="profile-blue.png">
      </div>
      <div id="notificationNav" class="nav-icon ">
        <img  id="notiGray" src="notification.png">
        <img  id="notiBlue" src="notafication-blue.png">
      </div>
      </div>
      <div class="underline"></div>
    </div>
    
    <div class="nav-right">
      <div class="search-icon-box">
        <i class='bx bx-search'></i>
      </div>
      <div class="profile-circle " onclick="toggleDropdown()">
      <img class="profile-img">
    </div>
    </div>
    
    
  </nav>
  
  <div class="mobail-nav">
    <div class="nav-top">
      <img src="logo-blue.png">
    </div>
    <div class="nav-bottom">
      
      <div class="navMDisplayFlex">
        <a href="#" >
      <div id="homNavM" class="nav-mobail">
        <img id="homeBlueM" src="home-blue.png">
        <img id="homeGrayM" src="home.png">
        <div class="newFeedNotification">0</div>
      </div>
      </a>
      <a href="#">
      <div id="profileNavM" class="nav-mobail">
        <img  id="profileGrayM" src="profile.png">
        <img id="profileBlueM" src="profile-blue.png">
      </div>
      </a>
      <a href="#">
      <div id="notiNavM" class="nav-mobail">
        <img  id="notiGrayM" src="notification.png">
        <img  id="notiBlueM" src="notafication-blue.png">
      </div>
      </a>
      <a href="#">
      <div id="menuNavM" class="nav-mobail">
        <div class="nav-menu">
          <img class="profile-img">
        </div>
      </div>
      </a>
      </div>
      
       <div class="mUnderline"></div>
    </div>
  </div>
  
  
  <div class="drop-down-menu " id="dropdownMenu">
    
    <div class="user-profile-and-name ">
      <div class="menu-profile ">
        <img class="profile-img lazyload">
      </div>
      <h4 class="greet"></h4>
    </div>
    <div class="menu-item ">
      <img src="setting.png ">
      <h4>Settings & privacy</h4>
      <img id="menu-arrowPng" src="arrow.png ">
    </div>
    <div class="menu-item ">
      <img src="help.png ">
      <h4>Help & support</h4>
      <img id="menu-arrowPng" src="arrow.png ">
    </div>
    <div class="menu-item ">
      <img src="display.png ">
      <h4>Display & accessibility</h4>
      <img id="menu-arrowPng" src="arrow.png ">
    </div>
    <div class="menu-item ">
      <img src="feedback.png ">
      <h4>Give feedback</h4>
    </div>
    <div class="menu-item logout-btn">
      <img src="logout.png ">
      <h4>Log Out</h4>
    </div>
  </div>
  
     <div class="dropdown-search-box">
      <div class="search-inp">
        <input type="search" placeholder="Search Socialbook">
      </div>
      <div class="search-content-box">
        <div class="search-user-box">
          <div class="search-user-profile"></div>
          <div class="search-user-name">
            <h4>User Name</h4>
            <p>user</p>
          </div>
        </div>
      </div>
    </div>




  <div class="main-container">
    <div class="left-sidebar"></div>
   <div class="main-content">
     <div class="post-create-container ">
       <div class="post-create-profile-box">
         <div class="post-create-profile">
           <img class="profile-img lazyload">
         </div>
       </div>
     <div class="textarea ">
         <p id="postTextarea">What do you think?</p>
       </div>
    </div>
    
    
    
    
    
    
    
    
    
    
    
    <!---
    <div class="post-upload-pogress-container">
      <img src="post.jpg">
      <p>Posting...</p>
    </div>--->
    
    <audio id="postSound" src="post-sound.mp3" preload="auto"></audio>
    
<!--- <div class="post ">
      <div class="post-header_and_post_content">
        <div class="profile-box ">
          <div class="post-profile">
         <img src="post.jpg ">
       </div>
     </div>
     <div class="post-userName-andtime">
       <h4>Lazim Mahmud</h4>
       
     </div>
     <div class="post-menu">
       <i class='bx bx-dots-vertical-rounded'></i>
     </div>
           </div>
         <div class="post-text ">
       <p>hello world welcome to socialbook and this is a social media platform in the world</p>
   </div>
 <div class="post-img ">
  <img src="post.jpg" id="databaseImg">
    </div>
      <div class="post-activity-container">
       <div class="post-activity-box ">
         <div onclick="toggleLike()" class="like-box ">
            <img id="likeGray" src="like.png">
              <img id="likeBlue" src="like-blue.png">
             <h4 id="likeText">Like</h4>
           </div>
         <div class="like-box ">
       <img src="comment.png">
     <h4>Comment</h4>
   </div>
     <div class="like-box ">
      <img src="share.png">
        <h4>Share</h4>
          </div>
             </div>
               </div>
          <div class="coment-display-container">
            
         
           <div class="user-coment-box">
              <div class="user-comment-profile">
                <img class="profile-img">
              </div>
              <div class="coment-content">
                <h4></h4>
                <p></p>
              </div>
              
            </div>
            
          </div>
          
         <div class="post-comment-container">
           <div class="comment-profile">
             <img class="profile-img">
           </div>
           <div class="comment-inp-box">
             <input type="text" placeholder="Write a public comment...">
           </div>
           <button class="comment-send-button" type="button"><i class='bx bxs-send' ></i></button>
         </div>
               
      </div>--->
      
     <!----<div class="post ">
      <div class="post-header_and_post_content">
              <div class="profile-box ">
                <div class="post-profile">
                   ${profileImageHTML}
                </div>
              </div>
              <div class="post-userName-andtime">
                <h4>${post.firstName} ${post.lastName} <span class="update-profile-text">Update his profile picture.</span></h4>
                <p class="span" id="post-time-${postId}">${formatRelativeTime(post.uploadTime)} <span>•</span><span> <i class='bx bx-world'></i></span></p>
              </div>
              <div class="post-menu">
                <i class='bx bx-dots-vertical-rounded'></i>
              </div>
            </div>
       <div class="profile-post-img ">
          <div class="profileImgCircle">
           <img src="post.jpg" id="databaseImg">
        </div>
      </div>
      <div class="post-activity-container">
       <div class="post-activity-box ">
         <div onclick="toggleLike()" class="like-box ">
            <img id="likeGray" src="like.png">
              <img id="likeBlue" src="like-blue.png">
             <h4 id="likeText">Like</h4>
           </div>
         <div class="like-box ">
       <img src="comment.png">
     <h4>Comment</h4>
   </div>
     <div class="like-box ">
      <img src="share.png">
        <h4>Share</h4>
          </div>
             </div>
               </div>
               
      </div>------>
      
              
        
    <div class="loading-post-container">
    <div class="loading-post">
       <div class="loading-profile-header">
         <div class="loading-profile"></div>
         <div class="bar-container">
           <div class="loading-bar"></div>
         <div style="margin-top: 9px; width: 35%;" class="loading-bar"></div>
         </div>
       </div>
     <div class="loading-bottom-bar">
           <div class="bar"></div>
           <div class="bar"></div>
           <div class="bar"></div>
         </div>
   </div>
   <div class="loading-post">
       <div class="loading-profile-header">
         <div class="loading-profile"></div>
         <div class="bar-container">
           <div class="loading-bar"></div>
         <div style="margin-top: 9px; width: 35%;" class="loading-bar"></div>
         </div>
       </div>
     <div class="loading-bottom-bar">
           <div class="bar"></div>
           <div class="bar"></div>
           <div class="bar"></div>
         </div>
   </div>
    
    
  </div>
     
              
   </div>
    
    <div class="right-sidebar"></div>
  </div>
  
  <div class="profile-page-container">
    <div class="profile-page ">
      <div class="profile-into-container ">
        <div class="cover-photo-container ">
          <img class="cover-img">
        </div>
        <div class="profile-photo-circle">
  <img class="profile-img">
</div>
        <button type="button" class="Edit-profile-btn ">Edit profile</button>
        <div class="profile-name-box ">
          <h3 class="greet "></h3>
          <p id="accountEmail"></p>
        </div>
        <div class="bio-container ">
          <p>Hello friend's welcome to my Socialbook account</p>
        </div>
        <div class="follower-container ">
          <p><span class="follow-count">0</span> Following</p>
          <p>•</p>
          <p><span class="follow-count">0</span> Followers</p>
        </div>
      </div>
      <div class="profile-page-post">
        
      </div>
    </div>
  </div>
  
  <div class="menu-page-container">
    <div class="menu-page">
      <h4>Menu</h4>
      <div class="menu-profile-cird">
        <div class="menu-profile-circle">
          <img class="profile-img">
        </div>
        <span class="menu-profile-name">
          <h4 style="font-size: 14px;" class="greet"></h4>
        </span>
      </div>
      <button type="button" class="lg-btn-menu">Log out</button>
    </div>
    
    <div class="logout-popup-opachity">
      <div class="lg-popup">
        <p>Log out of your account?</p>
        <div class="lg-two-btn-box">
        <button type="button" class="calcleBtn">CANCEL</button>
        <button type="button" class="lg logout-btn">Log out</button>
      </div>
      </div>
    </div>
  </div>
 
 
 
  <div class="edit-profile-popup-opachity ">
    
    <div class="edit-profile-popup ">
      <div class="edit-profile-popup-header ">
        <h4>Edit Profile</h4>
        <i class='bx bx-x-circle'></i>
      </div>
     <div class="popup-content-box ">
       <label for="coverImgInp">
        <div class="edit-profile-cover-box ">
          <i class='bx bxs-camera'></i>
        <img id="coverImgSelect">
        <input type="file" id="coverImgInp" accept="image/*" style="display: none;" >
      </div>
      </label>
      <label for="profileInp">
      <div class="edit-profile-box ">
         <i class='bx bxs-camera'></i>
        <img id="profileImgSleted">
        <input type="file" id="profileInp" accept="image/*" style="display: none;" >
      </div>
      </label>
      <br>
      <br>
      <br>
      <br>
      <br>
      <br>
      <div class="edit-input-box ">
        <input id="editName" type="text" placeholder="Name ">
      </div>
      <div class="edit-input-box ">
        <input type="text" placeholder="Bio ">
      </div>
      <div class="save-btn-container ">
        <button type="button" class="edit-save-btn">Save</button>
      </div>
     </div>
    </div>
    
  </div>
  
  <div class="popup-opachity "> 
    <div class="post-create-popup ">
      <div class="post-create-header ">
        <h4>Create post</h4>
        <i class='bx bx-x-circle'></i>
      </div>
      <div class="popup-content-box ">
        <div class="popup-profile-box ">
          <div class="popup-profile ">
            <img class="profile-img">
          </div>
          <h4 class="greet"></h4>
        </div>
        <div class="post-text-input ">
          <textarea id="textareaPlaceholder" cols="3" rows="3" placeholder="What do you think"></textarea>
        </div>
        <label for="fileInput">
        <div class="post-img-select-box ">
          <div class="img-select-icon ">
            <div class="icon-box ">
              <i class='bx bxs-image'></i>
            </div>
              <h4>Add Photos</h4>
          </div>
          <input type="file" id="fileInput" accept="image/*" style="display: none;" >
          <img id="selectedImage" >
        </div>
        </label>
        <button class="postBtn" id="uploadBtn">POST</button>
      </div>
    </div>
  </div>
  
  
  
  

    <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";
  import { getDatabase, ref as dbRef, set, get } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";
  
  const firebaseConfig = {
    apiKey: "AIzaSyDLiT3pWoHy1IK3StGdJQsiVndCSgl7XB8",
    authDomain: "socialbook-69ec5.firebaseapp.com",
    databaseURL: "https://socialbook-69ec5-default-rtdb.firebaseio.com",
    projectId: "socialbook-69ec5",
    storageBucket: "socialbook-69ec5.appspot.com",
    messagingSenderId: "720368891227",
    appId: "1:720368891227:web:ba2f4111a3b15ece5b967e"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const storage = getStorage(app);
  const database = getDatabase(app);





  document.getElementById('fileInput').addEventListener('change', function(event) {
  const file = event.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('selectedImage').src = e.target.result;
    };
    reader.readAsDataURL(file);
  }
});
  
  document.getElementById('uploadBtn').addEventListener('click', function () {
    const text = document.getElementById('textareaPlaceholder').value;
    const fileInput = document.getElementById('fileInput');
    const file = fileInput.files[0];

    if (text || file) {
        setTimeout(function () {
            const popupOpachityElement = document.querySelector('.popup-opachity');
            if (popupOpachityElement) {
                popupOpachityElement.style.display = 'none';
                document.querySelector('.mobail-nav').style.zIndex = '1';
            }
        }, 10);

        const userId = 'user123';  // Replace with actual user ID
        const userFirstName = UserInfo.firstName;
        const userLastName = UserInfo.lastName;
        const postId = new Date().getTime(); // Unique post ID based on timestamp
        const uploadTime = new Date().toISOString(); // Save current time

        let imageUrl = '';
        let profileImageUrl = '';

        // Create the post upload progress container
        const progressContainer = document.createElement('div');
        progressContainer.className = 'post-upload-pogress-container';
        const progressImage = document.createElement('img');
        const progressText = document.createElement('p');
        progressText.textContent = 'Posting...';

        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                progressImage.src = e.target.result;
            };
            reader.readAsDataURL(file);
        } else {
            progressImage.src = '';
        }

        progressContainer.appendChild(progressImage);
        progressContainer.appendChild(progressText);
        const postCreateContainer = document.querySelector('.post-create-container');
        postCreateContainer.insertAdjacentElement('afterend', progressContainer);

        // Function to handle image upload
        const uploadImage = () => {
            return new Promise((resolve, reject) => {
                if (file) {
                    const storageRef = ref(storage, 'images/' + postId + '-' + file.name);
                    uploadBytes(storageRef, file).then(snapshot => {
                        getDownloadURL(snapshot.ref).then(url => {
                            imageUrl = url;
                            resolve();
                        }).catch(reject);
                    }).catch(reject);
                } else {
                    resolve();
                }
            });
        };

        // Fetch profile image from Firebase Realtime Database
        const fetchProfileImage = () => {
            return new Promise((resolve, reject) => {
                let UserCreds = JSON.parse(localStorage.getItem("user-creds"));
                if (UserCreds && UserCreds.email) {
                    const email = UserCreds.email;
                    const formattedEmail = email.replace('.', ','); // Format email for database key
                    const userProfileDetailsRef = dbRef(database, 'User_Profile_details/' + formattedEmail);

                    get(userProfileDetailsRef).then(snapshot => {
                        if (snapshot.exists()) {
                            const data = snapshot.val();
                            if (data.profileImageURL) {
                                profileImageUrl = data.profileImageURL;
                            }
                            resolve();
                        } else {
                            console.log('No profile details found for this user.');
                            resolve(); // Resolve even if no data found
                        }
                    }).catch(error => {
                        console.error('Error fetching profile image:', error);
                        reject(error);
                    });
                } else {
                    console.error('No user credentials found in local storage.');
                    resolve(); // Resolve even if no user credentials
                }
            });
        };

        // Save text and user details to Firebase Realtime Database
        Promise.all([uploadImage(), fetchProfileImage()]).then(() => {
            return set(dbRef(database, 'All_Post/' + postId), {
                userId: userId,
                firstName: userFirstName,
                lastName: userLastName,
                text: text,
                timestamp: postId,
                uploadTime: uploadTime,
                imageUrl: imageUrl, // Save image URL if available
                profileImageUrl: profileImageUrl // Save profile image URL
            });
        }).then(() => {
            // Save post details under the user's email node
            let UserCreds = JSON.parse(localStorage.getItem("user-creds"));
            if (UserCreds && UserCreds.email) {
                const email = UserCreds.email;
                const formattedEmail = email.replace('.', ','); // Format email for database key
                const userPostsRef = dbRef(database, 'User_Posts/' + formattedEmail + '/' + postId);

                return set(userPostsRef, {
                    firstName: userFirstName,
                    lastName: userLastName,
                    text: text,
                    timestamp: postId,
                    uploadTime: uploadTime,
                    imageUrl: imageUrl,
                    profileImageUrl: profileImageUrl
                });
            } else {
                return Promise.resolve(); // If no user credentials, resolve to avoid breaking the chain
            }
        }).then(() => {
            const postSound = document.getElementById('postSound');
            postSound.play();

            // Convert newlines to <br> tags
            const formattedText = text.replace(/\n/g, '<br>');

            const postContainerHTML = `
                <div class="post-header_and_post_content">
                    <div class="profile-box">
                        <div class="post-profile">
                            <img src="${profileImageUrl || 'no-profile.png'}">
                        </div>
                    </div>
                    <div class="post-userName-andtime">
                        <h4>${userFirstName} ${userLastName}</h4>
                        <p class="span" id="post-time-${postId}">${formatRelativeTime(uploadTime)} <span>•</span><span> <i class='bx bx-world'></i></span></p>
                    </div>
                    <div class="post-menu">
                        <i class='bx bx-dots-vertical-rounded'></i>
                    </div>
                </div>
                <div class="post-text">
                    <p>${formattedText}</p>
                </div>
                ${imageUrl ? `<div class="post-img"><img src="${imageUrl}" class="lazyload" id="databaseImg"></div>` : ''}
                <div class="post-activity-container">
                    <div class="post-activity-box ">
                        <div onclick="toggleLike('${postId}')" class="like-box " id="like-box-${postId}">
                            <img id="likeGray-${postId}" src="like.png">
                            <img id="likeBlue-${postId}" src="like-blue.png" style="display:none;">
                            <h4 id="likeText-${postId}">Like</h4>
                        </div>
                        <div class="like-box ">
                            <img  src="comment.png">
                            <h4>Comment</h4>
                        </div>
                        <div class="like-box ">
                            <img src="share.png">
                            <h4>Share</h4>
                        </div>
                    </div>
                </div>
                <div class="post-comment-container">
           <div class="comment-profile">
             <img class="profile-img">
           </div>
           <div class="comment-inp-box">
             <input type="text" placeholder="Write a public comment...">
           </div>
           <button class="comment-send-button" type="button"><i class='bx bxs-send' ></i></button>
         </div>`;

            const postContainer1 = document.createElement('div');
            postContainer1.className = 'post';
            postContainer1.innerHTML = postContainerHTML;

            const postContainer2 = postContainer1.cloneNode(true); // Clone for the second insertion

            // Insert under post-create-container
            progressContainer.insertAdjacentElement('afterend', postContainer1);
            progressContainer.style.display = 'none';

            // Insert within profile-page-post
            const profilePagePost = document.querySelector('.profile-page-post');
            if (profilePagePost) {
                profilePagePost.insertAdjacentElement('afterbegin', postContainer2);
            }

            document.getElementById('textareaPlaceholder').value = '';
            document.getElementById('fileInput').value = '';
            document.getElementById('selectedImage').src = '';

            // ** New code to save notification in a bucket **
            saveNotificationBucket(userId, postId, uploadTime, userFirstName, userLastName);

        }).catch(error => {
            console.error("Error creating post: ", error);
        });

    } else {
        alert("Please write something or select an image before posting.");
    }
});

// Lazy loading with IntersectionObserver
document.addEventListener("DOMContentLoaded", function() {
  const lazyImages = [].slice.call(document.querySelectorAll("img.lazyload"));

  if ("IntersectionObserver" in window) {
    let lazyImageObserver = new IntersectionObserver(function(entries, observer) {
      entries.forEach(function(entry) {
        if (entry.isIntersecting) {
          let lazyImage = entry.target;
          lazyImage.src = lazyImage.dataset.src;
          lazyImage.classList.remove("lazyload");
          lazyImageObserver.unobserve(lazyImage);
        }
      });
    });

    lazyImages.forEach(function(lazyImage) {
      lazyImageObserver.observe(lazyImage);
    });
  } else {
    // Fallback for older browsers
    lazyImages.forEach(function(lazyImage) {
      lazyImage.src = lazyImage.dataset.src;
      lazyImage.classList.remove("lazyload");
    });
  }
});


// Function to save notification in a bucket
function saveNotificationBucket(userId, postId, uploadTime, userFirstName, userLastName) {
    const notificationId = new Date().getTime(); // Unique notification ID
    const userBucketRef = dbRef(database, `New_Notifi/${userId}`); // Create bucket for user notifications

    // Create a new notification object
    const newNotificationRef = dbRef(database, `New_Notifi/${userId}/${notificationId}`);
    
    set(newNotificationRef, {
        userId: userId,
        postId: postId,
        timestamp: notificationId,
        uploadTime: uploadTime,
        message: `${userFirstName} ${userLastName} has posted a new update.`,
        read: false // To track if the notification has been read
    }).then(() => {
        console.log("Notification saved successfully in user's notification bucket.");
        updateNotificationCount(userId); // Update notification count after saving
    }).catch(error => {
        console.error("Error saving notification: ", error);
    });
}

// Function to update the notification count in the UI
function updateNotificationCount(userId) {
    const userBucketRef = dbRef(database, `New_Notifi/${userId}`);

    // Get all notifications for the user
    get(userBucketRef).then(snapshot => {
        if (snapshot.exists()) {
            const notifications = snapshot.val();
            const unreadCount = Object.values(notifications).filter(notification => !notification.read).length;

            // Update the count in the UI
            document.querySelector('.newFeedNotification').innerText = unreadCount;
        } else {
            // If no notifications, set count to 0
            document.querySelector('.newFeedNotification').innerText = 0;
        }
    }).catch(error => {
        console.error("Error fetching notifications: ", error);
    });
}

// Call updateNotificationCount when the page loads to set the initial notification count
window.onload = function() {
    const userId = "USER_ID_HERE"; // Replace with actual user ID
    updateNotificationCount(userId);
};


function formatRelativeTime(isoDate) {
  const now = new Date();
  const postTime = new Date(isoDate);
  const diffInSeconds = Math.floor((now - postTime) / 1000);

  const options = {
    weekday: 'short', // sat, sun
    month: 'short',   // Aug, Sep
    day: 'numeric',   // 17, 18
    hour: 'numeric',  // 12
    minute: 'numeric', // 30
    hour12: true      // PM, AM
  };

  if (diffInSeconds < 60) return `Just now`;  // পরিবর্তিত অংশ
const diffInMinutes = Math.floor(diffInSeconds / 60);
if (diffInMinutes < 60) return `${diffInMinutes}m ago`;
const diffInHours = Math.floor(diffInMinutes / 60);
if (diffInHours < 24) return `${diffInHours}h ago`;
const diffInDays = Math.floor(diffInHours / 24);
if (diffInDays <= 5) return `${diffInDays}d ago`;

  // If more than 5 days, show formatted date
  return postTime.toLocaleDateString('en-US', options);
}

// Function to update post times in real-time
function updatePostTimes() {
  const allPostTimes = document.querySelectorAll('[id^="post-time-"]');
  allPostTimes.forEach(postTimeElement => {
    const postId = postTimeElement.id.split('-')[2]; // Extract postId from element id
    const postTime = postTimeElement.getAttribute('data-upload-time');
    postTimeElement.innerHTML = `${formatRelativeTime(postTime)} <span>•</span><span> <i class='bx bx-world'></i></span>`;
  });
}

// Fetch and display posts when the page loads
window.addEventListener('load', () => {
  const loadingContainer = document.querySelector('.loading-post-container');
  loadingContainer.style.display = 'block';

  let UserCreds = JSON.parse(localStorage.getItem("user-creds"));
  if (UserCreds && UserCreds.email) {
    const email = UserCreds.email;
    const formattedEmail = email.replace('.', ','); // Format email for database key
    
    // Fetch and display all posts from 'posts'
    get(dbRef(database, 'All_Post')).then(snapshot => {
      if (snapshot.exists()) {
        const posts = snapshot.val();
        const postContainer = document.querySelector('.post-create-container');

        for (const postId in posts) {
          const post = posts[postId];
          const postElement = document.createElement('div');
          postElement.className = 'post';
          
          const imageHTML = post.imageUrl ? `<div class="post-img"><img src="${post.imageUrl}" class="lazyload" id="databaseImg"></div>` : '';
          const profileImageHTML = post.profileImageUrl 
              ? `<img src="${post.profileImageUrl}">` 
              : `<img src="no-profile.png" >`;

          postElement.innerHTML = `
  <div class="post-header_and_post_content">
    <div class="profile-box">
      <div class="post-profile">
        ${profileImageHTML}
      </div>
    </div>
    <div class="post-userName-andtime">
      <h4>${post.firstName} ${post.lastName}</h4>
      <p class="span" id="post-time-${postId}" data-upload-time="${post.uploadTime}">${formatRelativeTime(post.uploadTime)} <span>•</span><span> <i class='bx bx-world'></i></span></p>
    </div>
    <div class="post-menu">
      <i class='bx bx-dots-vertical-rounded'></i>
    </div>
  </div>
  <div class="post-text">
    <p>${post.text.replace(/\n/g, '<br>')}</p>
  </div>
  ${imageHTML}
  <div class="post-activity-container">
    <div class="post-activity-box">
      <div onclick="toggleLike('${postId}')" class="like-box" id="like-box-${postId}">
        <img id="likeGray-${postId}" src="like.png">
        <img id="likeBlue-${postId}" src="like-blue.png" style="display:none;">
        <h4 id="likeText-${postId}">Like</h4>
      </div>
      <div class="like-box">
        <img src="comment.png">
        <h4>Comment</h4>
      </div>
      <div class="like-box">
        <img src="share.png">
        <h4>Share</h4>
      </div>
    </div>
  </div>
  <div class="post-comment-container">
           <div class="comment-profile">
             <img class="profile-img">
           </div>
           <div class="comment-inp-box">
             <input type="text" placeholder="Write a public comment...">
           </div>
           <button class="comment-send-button" type="button"><i class='bx bxs-send' ></i></button>
         </div>`;
          
          postContainer.insertAdjacentElement('afterend', postElement);
        }

        // Start interval to update post times every minute
        setInterval(updatePostTimes, 60000); // Update every 60 seconds
      }
    }).catch(error => {
      console.error("Error fetching all posts: ", error);
    });

    // Fetch and display only logged-in user's posts from 'User_Posts'
    get(dbRef(database, 'User_Posts/' + formattedEmail)).then(snapshot => {
      if (snapshot.exists()) {
        const userPosts = snapshot.val();
        const profilePostContainer = document.querySelector('.profile-page-post');

        for (const postId in userPosts) {
          const post = userPosts[postId];
          const postElement = document.createElement('div');
          postElement.className = 'post';

          const imageHTML = post.imageUrl ? `<div class="post-img"><img src="${post.imageUrl}" class="lazyload" id="databaseImg"></div>` : '';
          const profileImageHTML = post.profileImageUrl 
              ? `<img src="${post.profileImageUrl}">` 
              : `<img src="no-profile.png">`;

          postElement.innerHTML = `
  <div class="post-header_and_post_content">
    <div class="profile-box">
      <div class="post-profile">
        ${profileImageHTML}
      </div>
    </div>
    <div class="post-userName-andtime">
      <h4>${post.firstName} ${post.lastName}</h4>
      <p class="span" id="post-time-${postId}" data-upload-time="${post.uploadTime}">${formatRelativeTime(post.uploadTime)} <span>•</span><span> <i class='bx bx-world'></i></span></p>
    </div>
    <div class="post-menu">
      <i class='bx bx-dots-vertical-rounded'></i>
    </div>
  </div>
  <div class="post-text">
    <p>${post.text.replace(/\n/g, '<br>')}</p>
  </div>
  ${imageHTML}
  <div class="post-activity-container">
    <div class="post-activity-box">
      <div onclick="toggleLike('${postId}')" class="like-box" id="like-box-${postId}">
        <img id="likeGray-${postId}" src="like.png">
        <img id="likeBlue-${postId}" src="like-blue.png" style="display:none;">
        <h4 id="likeText-${postId}">Like</h4>
      </div>
      <div class="like-box">
        <img src="comment.png">
        <h4>Comment</h4>
      </div>
      <div class="like-box">
        <img src="share.png">
        <h4>Share</h4>
      </div>
    </div>
  </div>
  <div class="post-comment-container">
           <div class="comment-profile">
             <img class="profile-img">
           </div>
           <div class="comment-inp-box">
             <input type="text" placeholder="Write a public comment...">
           </div>
           <button class="comment-send-button" type="button"><i class='bx bxs-send' ></i></button>
         </div>`;
          
          profilePostContainer.insertAdjacentElement('afterbegin', postElement);
        }

        // Start interval to update post times every minute
        setInterval(updatePostTimes, 60000); // Update every 60 seconds
      }
    }).catch(error => {
      console.error("Error fetching user posts: ", error);
    }).finally(() => {
      // Hide the loading spinner after all posts are loaded
      loadingContainer.style.display = 'none';
    });
  }
});
  
  
  
  // profile and cover image upload 
  document.querySelector('.edit-save-btn').addEventListener('click', async () => {
    const profileFile = document.getElementById('profileInp').files[0];
    const coverFile = document.getElementById('coverImgInp').files[0];

    let UserCreds = JSON.parse(localStorage.getItem("user-creds"));
    if (UserCreds && UserCreds.email) {
        const email = UserCreds.email;
        const formattedEmail = email.replace('.', ',');
        const userProfileDetailsRef = dbRef(database, 'User_Profile_details/' + formattedEmail);

        try {
            // Fetch the current data to preserve any existing values
            const snapshot = await get(userProfileDetailsRef);
            let currentData = {};
            if (snapshot.exists()) {
                currentData = snapshot.val();
            }

            let profileDownloadURL;
            let coverDownloadURL;

            // Update Profile Image if a new one is provided
            if (profileFile) {
                const profileImgRef = ref(storage, 'profileImages/' + profileFile.name);
                const uploadResult = await uploadBytes(profileImgRef, profileFile);
                profileDownloadURL = await getDownloadURL(uploadResult.ref);
                currentData.profileImageURL = profileDownloadURL;
            }

            // Update Cover Image if a new one is provided
            if (coverFile) {
                const coverImgRef = ref(storage, 'coverImages/' + coverFile.name);
                const coverUploadResult = await uploadBytes(coverImgRef, coverFile);
                coverDownloadURL = await getDownloadURL(coverUploadResult.ref);
                currentData.coverImageURL = coverDownloadURL;
            }

            // Save the updated data back to the database
            await set(userProfileDetailsRef, currentData);

            alert('Profile and/or cover images updated successfully!');

            // Update all images with class "profile-img" if profile image was updated
            if (profileDownloadURL) {
                const profileImgs = document.querySelectorAll('.profile-img');
                profileImgs.forEach(img => {
                    img.src = profileDownloadURL;
                });
            }

            // Update all images with class "cover-img" if cover image was updated
            if (coverDownloadURL) {
                const coverImgs = document.querySelectorAll('.cover-img');
                coverImgs.forEach(img => {
                    img.src = coverDownloadURL;
                });
            }

        } catch (error) {
            console.error('Error uploading images:', error);
        }
    } else {
        console.error('No email found in user creds.');
    }
});
  
  
  // profile and cover photo fetch 
  const loadProfileAndCoverImages = async () => {
    let UserCreds = JSON.parse(localStorage.getItem("user-creds"));
    if (UserCreds && UserCreds.email) {
        const email = UserCreds.email;
        const formattedEmail = email.replace('.', ','); // Format email for database key
        const userProfileDetailsRef = dbRef(database, 'User_Profile_details/' + formattedEmail);

        try {
            const snapshot = await get(userProfileDetailsRef);
            if (snapshot.exists()) {
                const data = snapshot.val();
                
                // Load Profile Image
                if (data.profileImageURL) {
                    const profileImageURL = data.profileImageURL;
                    const profileImages = document.querySelectorAll('.profile-img');
                    profileImages.forEach(img => {
                        img.src = profileImageURL;
                    });
                } else {
                    console.log('No profile image found for this user.');
                }

                // Load Cover Image
                if (data.coverImageURL) {
                    const coverImageURL = data.coverImageURL;
                    const coverImages = document.querySelectorAll('.cover-img');
                    coverImages.forEach(img => {
                        img.src = coverImageURL;
                    });
                } else {
                    console.log('No cover image found for this user.');
                }
            } else {
                console.log('No profile details found for this user.');
            }
        } catch (error) {
            console.error('Error fetching profile and cover image URLs:', error);
        }
    } else {
        console.error('No user credentials found in local storage.');
    }
};

window.addEventListener('load', loadProfileAndCoverImages);
  
  
</script>
  
  
  
  
  <script>
    let UserCreds = JSON.parse(localStorage.getItem("user-creds"));
    let UserInfo = JSON.parse(localStorage.getItem("user-info"));

    let MsgHead = document.getElementById('accountEmail');
    let GreetHeads = document.querySelectorAll('.greet'); // Select all elements with class 'greet'
    let LogOutBtns = document.querySelectorAll('.logout-btn');
    let PostTextarea = document.getElementById('postTextarea');
    let textareaPlaceholder = document.getElementById('textareaPlaceholder');
    let nameInput = document.getElementById('editName');

    let logOut = () => {
        localStorage.removeItem("user-creds");
        localStorage.removeItem("user-info");
        window.location.href = 'index.html';
    }

    let CheckCred = () => {
        if (!localStorage.getItem("user-creds")) {
            window.location.href = 'index.html';
        } else {
            MsgHead.innerText = `${UserCreds.email}`;
            GreetHeads.forEach(element => {
                element.innerText = `${UserInfo.firstName} ${UserInfo.lastName}`;
            });
            // Set the placeholder text with user's first name
            PostTextarea.innerText = `What do you think ${UserInfo.firstName}?`;
            textareaPlaceholder.placeholder = `What do you think ${UserInfo.firstName}?`
            nameInput.value = `${UserInfo.firstName} ${UserInfo.lastName}`;
        }
    }

    window.addEventListener('load', CheckCred);

    // Add event listener to all logout buttons
    LogOutBtns.forEach(btn => {
        btn.addEventListener('click', logOut);
    });
</script>
  <script src="script.js"></script>
</body>
</html>
